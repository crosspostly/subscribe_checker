# CheckSub Bot

Современный Telegram бот на Python с использованием [aiogram 3.x](https://github.com/aiogram/aiogram), `asyncio` и `aiosqlite` для асинхронной проверки подписки новых участников группы на заданные каналы.

## Философия и Подход

Проект следует принципам **Объектно-Ориентированного Программирования (ООП)** для лучшей организации, расширяемости и поддерживаемости кода. Ключевые компоненты, такие как работа с базой данных (`DatabaseManager`), управление каналами (`ChannelManagementService`), проверка подписки (`SubscriptionService`), генерация и проверка капчи (`CaptchaService`), вынесены в отдельные классы.

**Структура проекта** организована по модульному принципу, разделяя логику на:
*   **Обработчики (`handlers`)**: Прием и первичная обработка команд, сообщений и коллбэков. Разделены на обработчики для ЛС, групп, админских функций и FSM.
*   **Сервисы (`services`)**: Реализация основной бизнес-логики (настройка каналов, проверка подписок, капча).
*   **База данных (`db`)**: Взаимодействие с SQLite, включая миграции схемы.
*   **Middleware (`middlewares`)**: Промежуточная обработка запросов (например, добавление экземпляров `DatabaseManager` и `Bot` в обработчики).
*   **Конфигурация (`config.py`)**: Управление настройками через переменные окружения (`pydantic-settings`).
*   **Данные (`data`)**: Определения структур данных, таких как `CallbackData` (`callback_data.py`).
*   **Экземпляры (`bot_instance.py`)**: Централизованная инициализация и хранение основных экземпляров бота (`Bot`, `Dispatcher`, `DatabaseManager`) и глобальных переменных состояния (например, `actual_bot_username`).
*   **Вспомогательные утилиты (`utils`), клавиатуры (`keyboards`), состояния FSM (`states`), тексты и константы (`texts`).**

**Документирование**: Каждый Python-модуль (`.py` файл) начинается с **документирующей строки (docstring)** в тройных кавычках (`"""Docstring..."""`), кратко описывающей назначение модуля. Это стандартная практика для улучшения читаемости и автоматической генерации документации в будущем.

## Основные Возможности

*   **Проверка подписки**: Автоматическая проверка новых участников группы на подписку на каналы, добавленные администратором чата. Сообщения от неподписанных пользователей удаляются, а после нескольких нарушений подряд пользователь получает временный мут.
*   **Капча**: Простая капча (кнопка "Я не робот") для новых участников для фильтрации спам-ботов. Включается/отключается командой `/togglecaptcha` в группе.
*   **Гибкая настройка и активация чатов**:
    *   **Инициация через код**: Администратор группы получает уникальный код (`/code` в ЛС с ботом) и отправляет его в целевую группу.
    *   **Подтверждение администратором**: Бот запрашивает у администратора в ЛС подтверждение на настройку чата.
    *   **Участие владельца бота**: Если чат настраивает не владелец бота, запрос на активацию и настройку отправляется владельцу. Владелец может:
        *   Одобрить и самостоятельно настроить каналы.
        *   Одобрить и предоставить администратору особый доступ для самостоятельной настройки каналов (временно или постоянно).
        *   Отклонить запрос.
    *   **FSM для настройки каналов**: Добавление и удаление каналов для проверки происходит через удобный интерфейс в личных сообщениях (FSM). Администратор (или владелец) выбирает каналы, бот проверяет наличие у себя прав администратора в этих каналах.
*   **Управление чатом (для администраторов в группе)**:
    *   `/togglecaptcha`: Включение/выключение проверки капчей для новых участников.
    *   `/togglesubcheck`: Включение/выключение проверки подписки на каналы.
    *   `/managechannels`: Повторный вызов интерфейса настройки каналов для уже активированного чата (в ЛС).
*   **Регистрация пользователя**: Бот запоминает пользователей при первом взаимодействии (`/start`). Фиксируется ID пользователя, по чьей ссылке (`/start USER_ID`) пришел новый пользователь.
*   **Интерфейс в ЛС**:
    *   `/start [ID_реферера]`: Показывает приветственное сообщение и основную информацию.
    *   `/code`: Получение уникального кода для инициации настройки нового чата.
    *   `/chats`: Просмотр списка чатов, которые пользователь настраивал, с возможностью перейти к управлению каналами для каждого.
*   **Фоновые задачи**:
    *   Ежедневные напоминания администраторам о чатах, которые были настроены, но еще не активированы владельцем.
    *   Периодическая очистка старых лог-файлов для предотвращения переполнения диска.
    *   Периодическое удаление старых сервисных сообщений бота из чатов.
*   **Асинхронность**: Использует `asyncio` и `aiogram` для эффективной обработки множества запросов.
*   **Логирование**: Подробное логирование действий и ошибок в консоль (с цветами, если установлен `colorlog`) и в файл `logs/bot.log`.

## Недавние улучшения
*   Устранены ошибки инициализации базы данных, связанные с созданием индексов для несуществующих колонок.
*   Исправлена ошибка при вызове периодической задачи очистки старых сообщений.
*   Улучшена логика определения актуального юзернейма бота при старте для корректного отображения в командах.
*   **Добавлена команда `/help`**, предоставляющая подробную справку по командам бота как в личных сообщениях, так и в группах.
*   Исправлено форматирование вывода команды `/listchannels` (используется HTML-разметка для корректного отображения ID каналов).
*   Внедрены улучшения в логирование событий присоединения пользователей к чату.
*   Скорректировано сообщение об отклонении запроса на активацию чата владельцем, теперь оно содержит контакт для связи.
*   Капча теперь включена по умолчанию для новых чатов (значение `captcha_enabled` по умолчанию 1 в БД). Создан скрипт `migrate_captcha_default.py` для обновления существующих чатов.

## Планируемые Возможности (TODO)

*   **Команда `/help`**: Подробная справка по всем командам и процессу настройки.
*   **Локализация (i18n)**: Перевод интерфейса на разные языки.
*   **Более гибкие настройки мута**: Возможность настраивать длительность мута за непрохождение проверки подписки.
*   **Статистика для владельца**: Базовая статистика по использованию бота (количество чатов, пользователей и т.д.).
*   **Автоматическое тестирование**: Внедрение автоматических тестов (unit/integration) для повышения надежности кода и упрощения рефакторинга.

## Установка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL вашего репозитория>
    cd checksubbot
    ```

2.  **Создайте и активируйте виртуальное окружение** (рекомендуется):
    ```bash
    python -m venv venv
    # Windows
    .\venv\Scripts\activate
    # Linux / macOS
    source venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте переменные окружения:**
    *   Скопируйте `.env.example` в `.env` (если `.env.example` существует, иначе создайте `.env` вручную).
    *   Откройте `.env` и укажите ваш `BOT_TOKEN`.
    *   (Опционально, для идентификации владельца и связи с ним) Укажите `BOT_OWNER_ID` (ваш Telegram User ID) и `BOT_OWNER_USERNAME` (ваш Telegram @username без @).
        ```dotenv
        BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
        # BOT_USERNAME больше не используется здесь, он определяется автоматически ботом при запуске.
        BOT_OWNER_ID=123456789         # Замените на ваш User ID
        BOT_OWNER_USERNAME=YourOwnerUsername # Замените на ваш Telegram Username (без @)
        ```

## Запуск

Убедитесь, что виртуальное окружение активировано и файл `.env` настроен.

```bash
python -m bot
```

Бот начнет работу в режиме polling. Логи будут выводиться в консоль и записываться в `logs/bot.log`.

## Использование

### В личных сообщениях с ботом (ЛС):

*   `/start [ID_реферера]`
    *   Для новых пользователей: Показывает приветственное сообщение. Если вы пришли по реферальной ссылке вида `t.me/YourBotName?start=USER_ID`, бот запишет `USER_ID` как вашего реферера.
    *   Для существующих пользователей: Показывает основную информацию и может предоставлять доступ к другим функциям (например, `/chats`).
*   `/code`
    *   **Ключевая команда для настройки нового чата.** Бот пришлет вам в ЛС уникальный код вида `setup_ВАШ_USER_ID`.
    *   Этот код нужно скопировать и отправить в ту группу, которую вы хотите настроить для работы с ботом.
*   `/chats`
    *   Показывает список чатов, которые вы успешно настроили или для которых являетесь администратором с правом управления ботом.
    *   Для каждого чата будет отображен его статус и предоставлена кнопка "⚙️ Управлять", нажав на которую вы перейдете в интерфейс управления списком каналов для проверки подписки в этом чате.
*   `/help`
    *   Отображает подробную справку по всем командам и процессу работы с ботом. Включает описание команд для ЛС и для администраторов в группе.

### В группе:

1.  **Добавление бота в группу и предоставление прав:**
    *   Добавьте вашего бота в целевую группу.
    *   Назначьте бота администратором группы. Минимально необходимые права: "Удаление сообщений" и "Блокировка пользователей" (для функции мута).
    *   При добавлении в админы бот отправит в группу приветственное сообщение с инструкцией по дальнейшей настройке.

2.  **Инициация настройки чата (для администраторов группы):**
    *   Администратор группы, желающий настроить бота, должен сначала получить код в ЛС с ботом с помощью команды `/code`.
    *   Затем этот администратор отправляет полученный код (например, `setup_123456789`) в группу.
    *   Бот удалит сообщение с кодом из группы.

3.  **Подтверждение и настройка (происходит в ЛС администратора):**
    *   После отправки кода в группу, бот пришлет администратору в ЛС запрос на подтверждение настройки для этого чата.
    *   Если администратор нажимает "Да, настроить":
        *   **Если администратор является владельцем бота** (чей `BOT_OWNER_ID` указан в `.env`): Чат автоматически активируется, и владелец сразу переходит к интерфейсу добавления/удаления каналов для проверки подписки.
        *   **Если администратор не является владельцем бота**: Администратору придет сообщение, что запрос на активацию и настройку отправлен владельцу бота. Владельцу бота придет уведомление в ЛС с опциями:
            *   "✅ Настроить и активировать": Владелец одобряет запрос, чат активируется, и владелец сам переходит к настройке списка каналов для этого чата.
            *   "🔑 Активировать и выдать доступ": Владелец одобряет запрос, чат активируется, и владелец переходит к FSM для указания срока (в днях, 0 - бессрочно), на который администратору будет предоставлен особый доступ (например, для самостоятельной настройки каналов или обхода проверок).
            *   "❌ Отклонить запрос": Запрос администратора отклоняется.
        *   Администратор будет уведомлен о решении владельца.
    *   Интерфейс настройки списка каналов (FSM) позволяет добавлять каналы (путем пересылки сообщения из целевого канала, где бот должен быть админом) и удалять их.

4.  **Управление уже настроенным чатом (для администраторов группы):**
    *   `/managechannels`
        *   Позволяет администратору группы (у которого есть на это права) снова открыть интерфейс управления списком каналов для текущего чата (запускает процесс в ЛС).
    *   `/togglecaptcha`
        *   Включает или выключает проверку капчей для новых пользователей в текущем чате.
    *   `/togglesubcheck`
        *   Включает или выключает проверку подписки на обязательные каналы для пользователей в текущем чате.
    *   `/addchannel <ID канала или @username>`
        *   Добавляет канал в список для проверки подписки.
    *   `/removechannel <ID канала или @username>`
        *   Удаляет канал из списка для проверки подписки.
    *   `/listchannels`
        *   Показывает текущий список каналов, настроенных для проверки подписки в данном чате.

## Структура проекта

```
checksubbot/
├── bot/                    # Основной код бота
│   ├── data/               # Определения структур данных (CallbackData)
│   │   ├── callback_data.py
│   │   └── __init__.py
│   ├── db/                 # Работа с базой данных (SQLite)
│   │   ├── database.py     # Класс DatabaseManager, миграции
│   │   └── __init__.py
│   ├── handlers/           # Обработчики событий Telegram
│   │   ├── admin.py        # Команды админов групп, обработчики коллбэков владельца в ЛС
│   │   ├── callbacks.py    # Общие обработчики нажатий инлайн-кнопок (если есть)
│   │   ├── fsm_private.py  # Обработчики состояний FSM для ЛС (настройка чата, выдача доступа)
│   │   ├── group_admin.py  # Команды и действия админов в группах (инициация настройки)
│   │   ├── group_messages.py # Обработчики сообщений и входа/выхода в группах (капча, проверка подписки)
│   │   ├── private_messages.py # Команды в ЛС (/start, /code, /chats)
│   │   └── __init__.py
│   ├── keyboards/          # Создание клавиатур
│   │   ├── inline.py       # Инлайн-клавиатуры
│   │   ├── reply.py        # Реплай-клавиатуры (если используются)
│   │   └── __init__.py
│   ├── middlewares/        # Middlewares aiogram
│   │   ├── bot_middleware.py # Передача экземпляра Bot
│   │   ├── db_middleware.py  # Передача экземпляра DatabaseManager
│   │   └── __init__.py
│   ├── services/           # Бизнес-логика
│   │   ├── captcha.py      # Сервис для генерации и проверки капчи
│   │   ├── channel_mgmt.py # Управление списком каналов (FSM)
│   │   ├── subscription.py # Логика проверки подписки
│   │   └── __init__.py
│   ├── states.py           # Определения состояний FSM
│   ├── utils/              # Вспомогательные функции
│   │   ├── helpers.py      # Общие вспомогательные функции (например, get_user_mention_html)
│   │   └── __init__.py
│   ├── bot_instance.py     # Инициализация Bot, Dispatcher, DatabaseManager, actual_bot_username
│   ├── config.py           # Загрузка конфигурации (токен и т.д.)
│   ├── texts.py            # Строковые константы и шаблоны сообщений
│   ├── __init__.py
│   └── __main__.py         # Точка входа для запуска `python -m bot`
├── logs/                   # Директория для файлов логов
│   └── bot.log
├── venv/                   # Виртуальное окружение (обычно в .gitignore)
├── .env                    # Файл с переменными окружения (BOT_TOKEN, BOT_OWNER_ID и др.)
├── .env.example            # Пример файла .env
├── .gitignore              # Файлы, игнорируемые Git
├── requirements.txt        # Зависимости Python
├── README.md               # Этот файл
└── структура_таблиц.md   # Описание схемы базы данных
``` 