# Полное Техническое Задание (ТУДУ) для Финальной Версии Бота

Этот документ описывает **все** функции, которые должны быть реализованы в финальной версии `Code.gs` для исправления всех текущих проблем и добавления нового функционала.

## ЧАСТЬ 1: КРИТИЧЕСКИЕ ИСПРАВЛЕНИЯ

### ✅ **Задача №1: Полностью Уничтожить СПАМ от CAPTCHA**
-   **Проблема:** Бот отправляет CAPTCHA-сообщения не только при вступлении, но и при любом другом событии (например, снятие мута), что приводит к спаму и ложным срабатываниям с `id=undefined`.
-   **Решение:** Полностью переписать логику `handleNewChatMember`. Бот должен срабатывать **только** при выполнении строгого условия: `update.chat_member.old_chat_member.status` был `'left'` или `'kicked'`, а `update.chat_member.new_chat_member.status` стал `'member'`. Это на 100% гарантирует реакцию только на физическое вступление нового пользователя в чат.

## ЧАСТЬ 2: НОВЫЙ ФУНКЦИОНАЛ (Удобство и Безопасность)

### ✅ **Задача №2: Создать Надежную Систему Конфигурации**
-   **Проблема:** Если в листе `Config` нет какой-то настройки, бот ломается.
-   **Решение:**
    1.  Внутри `Code.gs` создать глобальный объект `DEFAULT_CONFIG` со "страховочными" настройками по умолчанию.
    2.  Создать функцию `getCachedConfig`, которая сначала загружает эти настройки по умолчанию, а затем пытается перезаписать их значениями из листа `Config`.
    3.  Таким образом, если настройка в таблице есть — бот использует ее. Если ее нет — бот использует безопасное значение из кода и не ломается.
    4.  Эта же функция будет кэшировать настройки на 5 минут для высокой производительности.


### ✅ **Задача №4: Добавить "Белый Список" (Whitelist)**
-   **Проблема:** Нет спосо-ба игнорировать сообщения от доверенных пользователей или других ботов.
-   **Решение:**
    1.  Создать в таблице новый лист `Whitelist`.
    2.  Бот при запуске будет считывать все ID из этого листа.
    3.  При любом событии (сообщение, вступление) бот будет проверять, не находится ли `user.id` или `sender_chat.id` в этом списке. Если да — он полностью игнорирует событие.

### ✅ **Задача №5: Добавить Список Авторизованных Чатов**
-   **Проблема:** Бот работает во всех чатах, куда его добавят. Это небезопасно.
-   **Решение:**
    1.  Добавить в лист `Config` настройку `authorized_chat_ids`.
    2.  В эту ячейку можно будет вписать один или несколько ID чатов (каждый с новой строки).
    3.  При любом событии бот будет проверять, находится ли `chat.id` в этом списке. Если нет — он полностью игнорирует событие.


### ✅ **Задача №7: "Умная" обработка постов из каналов**
-  **Проблема:** Нужно игнорировать посты из своего канала, но удалять из чужих.
- **Решение:**
    1. Бот будет автоматически пропускать (не удалять и не проверять) любые посты, которые приходят из вашего целевого канала (`target_channel_id`).
    2. Для всех остальных каналов, которые постят в ваш чат, бот будет применять общие правила. То есть, если вы хотите, чтобы посты из другого, дружественного канала не удалялись, вам нужно будет добавить ID этого канала в `Whitelist`.

---
Это полное ТЗ. Я немедленно приступаю к его выполнению, начиная с зачистки старого кода и написания нового, который реализует все эти пункты.
const isRealJoin = (chatMember.old_chat_member.status === 'left') 
                 && chatMember.new_chat_member.status === 'member';
