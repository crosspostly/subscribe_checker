# üîÑ Migration Guide - Apps Script Bot Optimization

**–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é Google Apps Script –±–æ—Ç–∞**

---

## üìã **Pre-Migration Checklist**

### ‚úÖ **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:**

1. **Backup —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞:**
   ```javascript
   // –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π app_script/Code.gs
   // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ Google Sheets –¥–∞–Ω–Ω—ã–µ (Config, Whitelist, Users, Logs)
   ```

2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   - ID –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
   - ID —Ü–µ–ª–µ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞  
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
   - –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é:**
   - –ï—Å–ª–∏ —É –≤–∞—Å –≤–µ—Ä—Å–∏—è –¥–æ –æ–∫—Ç—è–±—Ä—è 2024 ‚Üí **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

## üöÄ **Migration Options**

### **Option 1: Clean Installation (Recommended)**

**–î–ª—è –Ω–æ–≤—ã—Ö –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–π –∏–ª–∏ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```bash
# 1. Backup —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
# 2. –ó–∞–º–µ–Ω–∏—Ç–µ –≤–µ—Å—å Code.gs –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
# 3. –ó–∞–º–µ–Ω–∏—Ç–µ tests.gs –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π  
# 4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ initialSetup()
# 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ backup
```

### **Option 2: Sequential Patches**

**–î–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```bash
# –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –ø–∞—Ç—á–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É:
git apply 0001-feat-improve-subscription-warning-with-channel-URL.patch
# –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ
git apply 0002-feat-add-inline-keyboard-buttons-for-subscription-ch.patch  
# –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ
git apply 0003-fix-major-bugfix-proper-new-member-handling-chat-joi.patch
# –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ
```

### **Option 3: One-Shot Patch**

**–î–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É
git apply complete_optimization_changes.patch
```

---

## ‚öôÔ∏è **Configuration Migration**

### **–ù–æ–≤—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è Config:**

| –°—Ç–∞—Ä–æ–µ –ø–æ–ª–µ | –ù–æ–≤–æ–µ –ø–æ–ª–µ | –ú–∏–≥—Ä–∞—Ü–∏—è |
|-------------|------------|----------|
| `bot_enabled` | `bot_enabled` | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `target_channel_id` | `target_channel_id` | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `authorized_chat_ids` | `authorized_chat_ids` | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| ‚ùå –ù–µ –±—ã–ª–æ | `target_channel_url` | **–î–û–ë–ê–í–ò–¢–¨** `https://t.me/yourchannel` |
| `captcha_mute_duration_min: 5` | `captcha_mute_duration_min: 30` | **–û–ë–ù–û–í–ò–¢–¨** |
| `captcha_message_timeout_sec: 300` | `captcha_message_timeout_sec: 30` | **–û–ë–ù–û–í–ò–¢–¨** |
| `warning_message_timeout_sec: 30` | `warning_message_timeout_sec: 20` | **–û–ë–ù–û–í–ò–¢–¨** |

### **Whitelist Migration:**

```javascript
// –°–¢–ê–†–´–ô –§–û–†–ú–ê–¢ (—á–∞—Å—Ç–∏—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è):
Whitelist –ª–∏—Å—Ç: —Ç–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª—ã –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å

// –ù–û–í–´–ô –§–û–†–ú–ê–¢ (–ø–æ–ª–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è):
Whitelist –ª–∏—Å—Ç: 
- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±—É–¥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)
- ID –∫–∞–Ω–∞–ª–æ–≤ (–ø–æ—Å—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è) 
- ID –±–æ—Ç–æ–≤ (–≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
```

---

## üîç **Breaking Changes**

### **‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è:**

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–∞—è:**
   ```javascript
   // –î–û: –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è –ø–æ–∑–¥–Ω–æ
   // –ü–û–°–õ–ï: –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ
   ```

2. **–ê–¥–º–∏–Ω—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è —Ä–∞–Ω—å—à–µ:**
   ```javascript  
   // –î–û: –ê–¥–º–∏–Ω—ã –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å –≤ handleMessage
   // –ü–û–°–õ–ï: –ê–¥–º–∏–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ handleUpdate
   ```

3. **CAPTCHA —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö join:**
   ```javascript
   // –î–û: CAPTCHA –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —á–∞—Ç–∞
   // –ü–û–°–õ–ï: CAPTCHA —Ç–æ–ª—å–∫–æ left‚Üímember, restricted‚Üímember
   ```

4. **–ù–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
   ```javascript
   // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫:
   // 1. –ë–æ—Ç—ã ‚Üí 2. –°–∏—Å—Ç–µ–º–Ω—ã–µ ‚Üí 3. –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ ‚Üí 4. –ê–¥–º–∏–Ω—ã ‚Üí 5. –õ–∏—á–∫–∞
   ```

---

## üß™ **Post-Migration Testing**

### **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

1. **–ó–∞–ø—É—Å–∫ test suite:**
   ```javascript
   runAllTests(); // –î–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ 33+ —Ç–µ—Å—Ç–æ–≤
   ```

2. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
   ```
   ‚úÖ –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Üí CAPTCHA –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
   ‚úÖ –ù–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –∫–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è  
   ‚úÖ –ê–¥–º–∏–Ω –ø–∏—à–µ—Ç ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   ‚úÖ –ë–æ—Ç –ø–∏—à–µ—Ç ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   ‚úÖ –ö–∞–Ω–∞–ª –ø–æ—Å—Ç–∏—Ç ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   ```

3. **Performance —Ç–µ—Å—Ç:**
   ```
   ‚úÖ –õ–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "filtered out early" –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö
   ‚úÖ –ù–µ—Ç –ª–∏—à–Ω–∏—Ö API –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã—Ö —Å–æ–±—ã—Ç–∏–π
   ```

---

## üö® **Troubleshooting**

### **–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:**

**1. CAPTCHA –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
logToSheet('INFO', 'Real user join detected: ...')

// –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
// - –ü—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ (can_restrict_members, can_delete_messages)
// - –ù–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º/–≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
```

**2. –ö–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è:**
```javascript
// –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ target_channel_url –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
Config –ª–∏—Å—Ç: target_channel_url = https://t.me/yourchannel

// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö:
logToSheet('INFO', 'Processing event for user ... after all filters passed')
```

**3. –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```javascript
// –ù–û–í–´–ô —Ñ–æ—Ä–º–∞—Ç Whitelist –ª–∏—Å—Ç–∞:
// [user_id, comment]
// 12345, "My other bot"
// -100777, "Partner channel"
```

**4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ —É–ª—É—á—à–∏–ª–∞—Å—å:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
logToSheet('DEBUG', 'Bot user ... Ignoring.')
logToSheet('DEBUG', 'Whitelisted user ... Ignoring.')
logToSheet('DEBUG', 'Admin ... Ignoring.')

// –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π –≤ handleUpdate
```

---

## üìä **Performance Metrics**

### **–û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

```bash
# API Calls —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ:
–î–û:  ~100 calls/–¥–µ–Ω—å –¥–ª—è 1000 —Å–æ–±—ã—Ç–∏–π
–ü–û–°–õ–ï: ~40 calls/–¥–µ–Ω—å –¥–ª—è 1000 —Å–æ–±—ã—Ç–∏–π  

# Response Time:
–î–û:  2-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
–ü–û–°–õ–ï: <1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

# –õ–æ–≥–∏:
–î–û:  –ú–Ω–æ–≥–æ DEBUG —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö
–ü–û–°–õ–ï: –ß–µ—Ç–∫–∏–µ "filtered out early" –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö
```

---

## üîÑ **Rollback Plan**

### **–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è:**

1. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:**
   ```javascript
   // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: Config, Whitelist, Users, Logs
   ```

2. **–û—Ç–∫–∞—Ç –∫–æ–¥–∞:**
   ```bash
   # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backup Code.gs –∏ tests.gs
   # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å git revert
   ```

3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   ```javascript
   // –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
   captcha_mute_duration_min: 5
   captcha_message_timeout_sec: 300  
   warning_message_timeout_sec: 30
   ```

---

## ‚úÖ **Migration Success Indicators**

### **–ö–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:**

```javascript
‚úÖ runAllTests() –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "filtered out early" –¥–ª—è –±–æ—Ç–æ–≤/–∞–¥–º–∏–Ω–æ–≤/–±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
‚úÖ CAPTCHA –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
‚úÖ –ù–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç –∫–Ω–æ–ø–∫–∏ —Å –∫–∞–Ω–∞–ª–æ–º
‚úÖ API calls —Å–æ–∫—Ä–∞—Ç–∏–ª–∏—Å—å –Ω–∞ ~60%
‚úÖ Response time —É–º–µ–Ω—å—à–∏–ª—Å—è
```

---

## üîó **Support Resources**

- üìñ **[IMPROVEMENTS_SUMMARY.md](./IMPROVEMENTS_SUMMARY.md)** - –î–µ—Ç–∞–ª–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- üöÄ **[DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)** - –ü–æ—à–∞–≥–æ–≤—ã–π –¥–µ–ø–ª–æ–π  
- üìù **[app_script/README.md](./app_script/README.md)** - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- üß™ **[app_script/tests.gs](./app_script/tests.gs)** - Test suite

---

**üí° –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ–∑–¥–∞–π—Ç–µ Issue –Ω–∞ GitHub —Å –ª–æ–≥–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏.**
